@startuml Conference Management System Class Diagram
!theme plain
skinparam classAttributeIconSize 0
skinparam backgroundColor #FFFFFF

package "Identity Service" #LightBlue {
  
  class User {
    + id: number
    + email: string
    + password: string
    + fullName: string
    + isVerified: boolean
    + roles: Role[]
    + refreshTokens: RefreshToken[]
    + createdAt: Date
    + updatedAt: Date
    + deletedAt: Date | null
    + isActive: boolean
    --
    + Đăng ký tài khoản()
    + Đăng nhập()
  }
}

package "Conference Service" #LightYellow {
  
  class Conference {
    + id: number
    + name: string
    + startDate: Date
    + endDate: Date
    + venue: string
    + description: string | null
    + shortDescription: string | null
    + contactEmail: string | null
    + organizerId: number
    + deletedAt: Date | null
    + isActive: boolean
    + tracks: Track[]
    + members: ConferenceMember[]
    + cfpSetting: CfpSetting | null
    --
    + Tạo hội nghị()
    + Cập nhật thông tin hội nghị()
    + Xóa hội nghị()
    + Xem danh sách hội nghị()
    + Xem chi tiết hội nghị()
  }

  class Track {
    + id: number
    + name: string
    + conferenceId: number
    + description: string | null
    + createdAt: Date
    + updatedAt: Date
    + deletedAt: Date | null
    + isActive: boolean
    + conference: Conference
    + members: TrackMember[]
    --
    + Thêm track()
    + Cập nhật track()
    + Xóa track()
  }

  class ConferenceMember {
    + id: number
    + conferenceId: number
    + userId: number
    + role: ConferenceMemberRole
    --
    + Thêm thành viên()
    + Xóa thành viên()
    + Cập nhật vai trò()
  }

  class TrackMember {
    + id: number
    + trackId: number
    + userId: number
    + status: string
    + createdAt: Date
    + updatedAt: Date
    --
    + Thêm thành viên track()
    + Chấp nhận thành viên()
    + Từ chối thành viên()
  }

  class CfpSetting {
    + id: number
    + conferenceId: number
    + submissionDeadline: Date
    + reviewDeadline: Date
    + notificationDate: Date
    + cameraReadyDeadline: Date
    --
    + Cấu hình deadline()
    + Cập nhật deadline()
  }

  class ConferencesService {
    - conferenceRepository: Repository<Conference>
    - trackRepository: Repository<Track>
    - conferenceMemberRepository: Repository<ConferenceMember>
    - trackMemberRepository: Repository<TrackMember>
    - cfpSettingRepository: Repository<CfpSetting>
    - emailService: EmailService
    - identityClient: IdentityClientService
    - submissionClient: SubmissionClientService
    - reviewClient: ReviewClientService
    --
    + createConference(dto: CreateConferenceDto, organizerId: number): Promise<Conference>
    + findAll(): Promise<Conference[]>
    + findOne(id: number): Promise<Conference>
    + addTrack(conferenceId: number, name: string, user: {...}): Promise<Track>
    + updateConference(id: number, dto: UpdateConferenceDto, user: {...}): Promise<Conference>
    + deleteConference(id: number, user: {...}): Promise<void>
    + updateTrack(conferenceId: number, trackId: number, dto: UpdateTrackDto, user: {...}): Promise<Track>
    + addTrackMember(trackId: number, dto: AddTrackMemberDto, user: {...}, authToken?: string): Promise<TrackMember>
    - ensureValidDateRange(start: string, end: string)
    - ensureCanManageConference(conferenceId: number, user: {...})
  }

  class ReportingService {
    - conferenceRepository: Repository<Conference>
    - trackRepository: Repository<Track>
    - submissionClient: SubmissionClientService
    --
    + getConferenceStats(conferenceId: number): Promise<{...}>
    + getTrackStats(conferenceId: number, trackId: number): Promise<{...}>
  }

  Conference "1" *-- "0..*" Track : contains
  Conference "1" -- "0..*" ConferenceMember : has
  Conference "1" -- "0..1" CfpSetting : has
  Track "1" -- "0..*" TrackMember : has
  ConferencesService --> Conference : manages
  ConferencesService --> Track : manages
  ReportingService --> Conference : uses
}

package "Submission Service" #LightGreen {
  
  class Submission {
    + id: string
    + title: string
    + abstract: string
    + keywords: string | null
    + fileUrl: string
    + status: SubmissionStatus
    + authorId: number
    + authorName: string | null
    + authorAffiliation: string | null
    + trackId: number
    + conferenceId: number
    + coAuthors: Array | null
    + cameraReadyFileUrl: string | null
    + createdAt: Date
    + updatedAt: Date
    + submittedAt: Date | null
    + deletedAt: Date | null
    + isActive: boolean
    + versions: SubmissionVersion[]
    --
    + Tạo bài nộp()
    + Cập nhật bài nộp()
    + Xóa bài nộp()
    + Cập nhật trạng thái()
    + Tải file()
  }

  class SubmissionVersion {
    + id: number
    + submissionId: string
    + versionNumber: number
    + title: string
    + abstract: string
    + fileUrl: string
    + keywords: string | null
    + createdAt: Date
    --
    + Tạo phiên bản()
    + Xem lịch sử phiên bản()
  }

  class SubmissionsService {
    - submissionRepository: Repository<Submission>
    - submissionVersionRepository: Repository<SubmissionVersion>
    - supabaseService: SupabaseService
    - conferenceClient: ConferenceClientService
    - reviewClient: ReviewClientService
    - identityClient: IdentityClientService
    --
    + uploadFile(file: Express.Multer.File | undefined): Promise<string>
    + create(dto: CreateSubmissionDto, authorId: number, file?: Express.Multer.File): Promise<Submission>
    + findAll(dto: QuerySubmissionsDto, userId?: number, userRoles?: string[]): Promise<{data: Submission[], total: number}>
    + findOne(id: string, userId?: number, userRoles?: string[]): Promise<Submission>
    + update(id: string, dto: UpdateSubmissionDto, authorId: number, file?: Express.Multer.File): Promise<Submission>
    + updateStatus(id: string, dto: UpdateStatusDto, userId: number, userRoles: string[]): Promise<Submission>
    + delete(id: string, authorId: number): Promise<void>
    - validateStatusTransition(currentStatus: SubmissionStatus, newStatus: SubmissionStatus): boolean
  }

  Submission "1" *-- "0..*" SubmissionVersion : has
  SubmissionsService --> Submission : manages
}

package "Review Service" #LightCoral {
  
  class Review {
    + id: number
    + assignmentId: number
    + conferenceId: number | null
    + score: number
    + confidence: ConfidenceLevel
    + commentForAuthor: string | null
    + commentForPC: string | null
    + recommendation: RecommendationType
    + createdAt: Date
    + updatedAt: Date
    + assignment: Assignment
    --
    + Tạo đánh giá()
    + Cập nhật đánh giá()
    + Xem đánh giá()
  }

  class Assignment {
    + id: number
    + reviewerId: number
    + submissionId: string
    + conferenceId: number | null
    + status: AssignmentStatus
    + assignedBy: number
    + dueDate: Date | null
    + createdAt: Date
    + updatedAt: Date
    + review: Review | null
    --
    + Tạo phân công()
    + Chấp nhận phân công()
    + Từ chối phân công()
    + Hoàn thành phân công()
  }

  class ReviewPreference {
    + id: number
    + reviewerId: number
    + submissionId: string
    + conferenceId: number | null
    + preference: PreferenceType
    + createdAt: Date
    + updatedAt: Date
    --
    + Đặt bid()
    + Cập nhật preference()
  }

  class ReviewsService {
    - reviewPreferenceRepository: Repository<ReviewPreference>
    - assignmentRepository: Repository<Assignment>
    - reviewRepository: Repository<Review>
    - conferenceClient: ConferenceClientService
    - submissionClient: SubmissionClientService
    - identityClient: IdentityClientService
    --
    + submitBid(reviewerId: number, dto: CreateBidDto): Promise<ReviewPreference>
    + checkConflictOfInterest(reviewerId: number, submissionId: string | number): Promise<boolean>
    + createAssignment(dto: CreateAssignmentDto, authToken: string): Promise<Assignment>
    + submitReview(reviewerId: number, dto: CreateReviewDto, authToken: string): Promise<Review>
    + getReviews(submissionId: string, authToken?: string): Promise<Review[]>
    + getReviewerActivityStats(reviewerId: number, authToken: string): Promise<{assignmentCount: number, reviewCount: number}>
  }

  Assignment "1" ||--|| Review : has
  ReviewsService --> Assignment : manages
  ReviewsService --> Review : manages
  ReviewsService --> ReviewPreference : manages
}

package "Integration Services" #LightGray {
  
  class IdentityClientService {
    - httpService: HttpService
    - configService: ConfigService
    --
    + getUserById(userId: number, authToken: string): Promise<User>
    + validateToken(token: string): Promise<boolean>
  }

  class ConferenceClientService {
    - httpService: HttpService
    - configService: ConfigService
    --
    + getConference(conferenceId: number, authToken: string): Promise<Conference>
    + getTrack(trackId: number, authToken: string): Promise<Track>
  }

  class SubmissionClientService {
    - httpService: HttpService
    - configService: ConfigService
    --
    + getSubmissionById(id: string, authToken: string): Promise<Submission | null>
    + getSubmissionIdsByTrack(trackId: number, authToken: string): Promise<string[]>
  }

  class ReviewClientService {
    - httpService: HttpService
    - configService: ConfigService
    --
    + getReviewerActivityStats(reviewerId: number, authToken: string): Promise<{assignmentCount: number, reviewCount: number}>
    + hasUserReviewedSubmissions(userId: number, submissionIds: string[], authToken: string): Promise<boolean>
  }
}

' Entity relationships
User "1" -- "0..*" Submission : author
User "1" -- "0..*" Assignment : reviewer
User "1" -- "0..*" ConferenceMember : member
User "1" -- "0..*" TrackMember : member
User "1" -- "0..*" ReviewPreference : reviewer

Conference "1" -- "0..*" Submission : contains
Track "1" -- "0..*" Submission : contains

Submission "1" -- "0..*" Assignment : has
Submission "1" -- "0..*" ReviewPreference : has

' Service dependencies
ConferencesService ..> IdentityClientService : uses
ConferencesService ..> SubmissionClientService : uses
ConferencesService ..> ReviewClientService : uses

SubmissionsService ..> ConferenceClientService : uses
SubmissionsService ..> ReviewClientService : uses
SubmissionsService ..> IdentityClientService : uses

ReviewsService ..> ConferenceClientService : uses
ReviewsService ..> SubmissionClientService : uses
ReviewsService ..> IdentityClientService : uses

@enduml
